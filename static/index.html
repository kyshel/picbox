<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href=" ./bootstrap-5.1.3-dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="./bootstrap-5.1.3-dist/js/bootstrap.bundle.min.js"></script>
    <script src="./jquery-3.6.0.min.js"></script>
    <script src="./vue.js"></script>


    <title>picbox</title>
  </head>








  
  <body>

    <!-- <div id="app">{{ message }}</div> -->
    <!-- <div><button class="btn">see bootstrap btn </button></div> -->
	<div><h1>Picbox 图片在线处理平台</h1>请先上传图，再选择功能</div>

 
    <div class="btn-group" role="group" aria-label="Basic outlined example">
        <button type="button" class="btn btn-primary" id="gray_btn" disabled>灰度</button>
        <button type="button" class="btn btn-primary" disabled>功能2</button>
        <button type="button" class="btn btn-primary" disabled>功能3</button>
    </div>

    <div class="container">
        <div class="row">
          <div class="col">
            <div >
                原图
                <img id="img" height="200">
            </div>
            
            <div id="file_div">
                <input id="inp" type="file"  />
            </div>
            <div>
                示例图片（功能暂不可用）
                <img src="example1_ym.jpg"  class="im_example" alt="yangmi" id="im_ym" height="100">
                <img src="example2_lena.png" class="im_example" alt="lena" height="100" >
                <img src="example3_ana.jpg" class="im_example"  alt="ana" height="100" >

            </div>
          </div>


          <div class="col">
            处理后的图
			<img id="img2"  height="200">
          </div>

        </div>
    </div>




    <script>
        var API_PATH = "./api";

        document.getElementById("inp").addEventListener("change", readFile);



        function readFile() {
			var file_input = document.getElementById("inp")
			if (file_input.files && file_input.files[0]) {
				var FR= new FileReader();
				var content = '';
				FR.addEventListener("load", function(e) {
					document.getElementById("img").src= e.target.result;

					// showLoader('Loaded image, uploading ...');
					var image = {
						"origin_name": file_input.files[0].name,
						"content":e.target.result
					};
					console.log(e.target.result)
					// console.log(image)
                    // deposit(image);

					$('#gray_btn').click(function() {
						gray(image)
					});
					$("#gray_btn").removeAttr("disabled");

				});
				FR.readAsDataURL(file_input.files[0]);

				FR.onloadstart = function(e){
					// $('#plate').html('<img id="img" >');
					// showLoader('Loading image...');
				};
			}
		}

		$('.im_example').click(function() {
			// $('.img1 img').attr('src');
			im_src = $(this).attr('src')
			useSample(im_src)
		});
		
		function toDataURL(url, callback) {
			var xhr = new XMLHttpRequest();
			xhr.onload = function() {
				var reader = new FileReader();
				reader.onloadend = function() {
					callback(reader.result);
				}
				reader.readAsDataURL(xhr.response);
			};
			xhr.open('GET', url);
			xhr.responseType = 'blob';
			xhr.send();
		}



		function useSample(im_src){
			toDataURL(im_src, function(dataUrl) {
				var data = dataUrl;
				document.getElementById("img").src= data;
				var parts = im_src.split('/');
				var fn_im = parts.pop() || parts.pop(); 

				// showLoader('Loaded image, uploading ...');
				var image = {
					"origin_name": fn_im,
					"content":data
				};

				
				$('#gray_btn').click(function() {
						gray(image)
				});
					$("#gray_btn").removeAttr("disabled");
			});

		}

		
 
        function gray(image) {
			var path = API_PATH + "/gray"

			$.ajax({
				url: path,
				// type: 'PUT',
				type: 'POST',
				dataType: "json",
				contentType: "application/json",
				data: JSON.stringify(image),
				success: function (response,status,xhr) { 
					// hideLoader();
					// console.log(response)
					// console.log(response.route_grayed)
					document.getElementById("img2").src       = response.route_grayed + '?'+ Date.now();



					// if (xhr.status == 201) {
					// 	console.log(response);

					// // showTricks();
					// // showFileOperation();
					// // $(".btn").prop("disabled", false);

					// // reloadUI();
					// // reloadImg();
					
					// }else{
					// 	console.log('deposit status not 201');
					// }

				},
				error: function (e){
					console.log('deposit error:');
								console.log(e);
				},
			})



			// }).success( function(response,status,xhr) {
			// 	// hideLoader();

			// 	if (xhr.status == 201) {
			// 		console.log(response);

			// 		// showTricks();
			// 		// showFileOperation();
			// 		// $(".btn").prop("disabled", false);

			// 		// reloadUI();
			// 		// reloadImg();
					
			// 	}else{
			// 		console.log('deposit status not 201');
			// 	}

			// }).error( function(e) {
			// 	console.log('deposit error:');
			// 	console.log(e);
			// });
		}



    </script>











    


    <script>
        Vue.createApp({
          data() {
            return {
              message: 'Vue is ok.'
            }
          }
        }).mount('#app')
    </script>



  </body>
</html>